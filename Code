import tkinter as tk
from tkinter import ttk, messagebox
import sqlite3
from datetime import datetime


DB_NAME = "angel_and_sparrow.db"


class AngelAndSparrowApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Angel & Sparrow - Donations and Volunteers")
        self.geometry("750x500")
        self.resizable(False, False)

        self.conn = sqlite3.connect(DB_NAME)
        self.create_tables()

        self.current_user = None  # (id, name, email)

        container = ttk.Frame(self)
        container.pack(fill="both", expand=True)

        self.frames = {}
        for F in (LoginFrame, RegisterFrame, DashboardFrame):
            frame = F(parent=container, controller=self)
            self.frames[F.__name__] = frame
            frame.grid(row=0, column=0, sticky="nsew")

        self.show_frame("LoginFrame")

    def create_tables(self):
        cur = self.conn.cursor()
        cur.execute("""
            CREATE TABLE IF NOT EXISTS donors (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                email TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL
            )
        """)
        cur.execute("""
            CREATE TABLE IF NOT EXISTS donations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                donor_id INTEGER NOT NULL,
                date TEXT NOT NULL,
                amount REAL NOT NULL,
                category TEXT,
                note TEXT,
                FOREIGN KEY(donor_id) REFERENCES donors(id)
            )
        """)
        cur.execute("""
            CREATE TABLE IF NOT EXISTS volunteers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                donor_id INTEGER,
                name TEXT NOT NULL,
                email TEXT NOT NULL,
                created_at TEXT NOT NULL,
                UNIQUE(email)
            )
        """)
        self.conn.commit()

    def show_frame(self, name):
        frame = self.frames[name]
        if name == "DashboardFrame" and self.current_user:
            frame.refresh()
        frame.tkraise()

    # -------- donor / auth helpers --------
    def register_donor(self, name, email, password):
        if not name or not email or not password:
            messagebox.showerror("Error", "All fields are required.")
            return False

        try:
            cur = self.conn.cursor()
            cur.execute(
                "INSERT INTO donors (name, email, password) VALUES (?, ?, ?)",
                (name.strip(), email.strip().lower(), password.strip())
            )
            self.conn.commit()
            messagebox.showinfo("Success", "Account created! You can now log in.")
            return True
        except sqlite3.IntegrityError:
            messagebox.showerror("Error", "That email is already registered.")
            return False

    def login_donor(self, email, password):
        cur = self.conn.cursor()
        cur.execute(
            "SELECT id, name, email, password FROM donors WHERE email = ?",
            (email.strip().lower(),)
        )
        row = cur.fetchone()
        if row and row[3] == password:
            self.current_user = (row[0], row[1], row[2])
            return True
        return False

    def add_donation(self, amount, category, note):
        if not self.current_user:
            messagebox.showerror("Error", "You must be logged in.")
            return
        try:
            amount_val = float(amount)
            if amount_val <= 0:
                raise ValueError
        except ValueError:
            messagebox.showerror("Error", "Please enter a valid positive amount.")
            return

        donor_id = self.current_user[0]
        cur = self.conn.cursor()
        cur.execute(
            "INSERT INTO donations (donor_id, date, amount, category, note) "
            "VALUES (?, ?, ?, ?, ?)",
            (
                donor_id,
                datetime.now().strftime("%Y-%m-%d %H:%M"),
                amount_val,
                category,
                note
            )
        )
        self.conn.commit()
        messagebox.showinfo("Thank you!", "Donation recorded successfully.")

    def get_donation_history(self):
        if not self.current_user:
            return []
        donor_id = self.current_user[0]
        cur = self.conn.cursor()
        cur.execute(
            "SELECT date, amount, COALESCE(category,''), COALESCE(note,'') "
            "FROM donations WHERE donor_id = ? ORDER BY date DESC",
            (donor_id,)
        )
        return cur.fetchall()

    def signup_volunteer(self):
        if not self.current_user:
            messagebox.showerror("Error", "You must be logged in.")
            return False

        donor_id, name, email = self.current_user
        cur = self.conn.cursor()
        try:
            cur.execute(
                "INSERT INTO volunteers (donor_id, name, email, created_at) "
                "VALUES (?, ?, ?, ?)",
                (donor_id, name, email,
                 datetime.now().strftime("%Y-%m-%d %H:%M"))
            )
            self.conn.commit()
            messagebox.showinfo(
                "Thank you!",
                "You have been added to the volunteer list."
            )
            return True
        except sqlite3.IntegrityError:
            messagebox.showinfo(
                "Already signed up",
                "You are already in the volunteer list."
            )
            return False

    def get_volunteer_stats(self):
        cur = self.conn.cursor()
        cur.execute("SELECT COUNT(*) FROM volunteers")
        total = cur.fetchone()[0]
        if not self.current_user:
            return total, False

        _, _, email = self.current_user
        cur.execute("SELECT 1 FROM volunteers WHERE email = ?", (email,))
        is_volunteer = cur.fetchone() is not None
        return total, is_volunteer


class LoginFrame(ttk.Frame):
    def __init__(self, parent, controller: AngelAndSparrowApp):
        super().__init__(parent)
        self.controller = controller

        title = ttk.Label(self, text="Angel & Sparrow", font=("Arial", 20, "bold"))
        title.pack(pady=20)

        subtitle = ttk.Label(self, text="Donor & Volunteer Portal", font=("Arial", 12))
        subtitle.pack(pady=(0, 20))

        form = ttk.Frame(self)
        form.pack(pady=10)

        ttk.Label(form, text="Email:").grid(row=0, column=0, sticky="e", padx=5, pady=5)
        ttk.Label(form, text="Password:").grid(row=1, column=0, sticky="e", padx=5, pady=5)

        self.email_var = tk.StringVar()
        self.password_var = tk.StringVar()

        email_entry = ttk.Entry(form, textvariable=self.email_var, width=30)
        password_entry = ttk.Entry(form, textvariable=self.password_var, show="*", width=30)
        email_entry.grid(row=0, column=1, padx=5, pady=5)
        password_entry.grid(row=1, column=1, padx=5, pady=5)

        btn_frame = ttk.Frame(self)
        btn_frame.pack(pady=10)

        login_btn = ttk.Button(btn_frame, text="Log In", command=self.login)
        login_btn.grid(row=0, column=0, padx=10)

        register_btn = ttk.Button(
            btn_frame, text="Create Account",
            command=lambda: controller.show_frame("RegisterFrame")
        )
        register_btn.grid(row=0, column=1, padx=10)

    def login(self):
        email = self.email_var.get()
        password = self.password_var.get()
        if self.controller.login_donor(email, password):
            self.email_var.set("")
            self.password_var.set("")
            self.controller.show_frame("DashboardFrame")
        else:
            messagebox.showerror("Login failed", "Invalid email or password.")


class RegisterFrame(ttk.Frame):
    def __init__(self, parent, controller: AngelAndSparrowApp):
        super().__init__(parent)
        self.controller = controller

        title = ttk.Label(self, text="Create Donor Account",
                          font=("Arial", 18, "bold"))
        title.pack(pady=20)

        form = ttk.Frame(self)
        form.pack(pady=10)

        ttk.Label(form, text="Full Name:").grid(row=0, column=0, sticky="e", padx=5, pady=5)
        ttk.Label(form, text="Email:").grid(row=1, column=0, sticky="e", padx=5, pady=5)
        ttk.Label(form, text="Password:").grid(row=2, column=0, sticky="e", padx=5, pady=5)

        self.name_var = tk.StringVar()
        self.email_var = tk.StringVar()
        self.password_var = tk.StringVar()

        name_entry = ttk.Entry(form, textvariable=self.name_var, width=30)
        email_entry = ttk.Entry(form, textvariable=self.email_var, width=30)
        password_entry = ttk.Entry(form, textvariable=self.password_var, show="*", width=30)

        name_entry.grid(row=0, column=1, padx=5, pady=5)
        email_entry.grid(row=1, column=1, padx=5, pady=5)
        password_entry.grid(row=2, column=1, padx=5, pady=5)

        btn_frame = ttk.Frame(self)
        btn_frame.pack(pady=10)

        back_btn = ttk.Button(
            btn_frame, text="Back to Login",
            command=lambda: controller.show_frame("LoginFrame")
        )
        back_btn.grid(row=0, column=0, padx=10)

        create_btn = ttk.Button(btn_frame, text="Create Account",
                                command=self.create_account)
        create_btn.grid(row=0, column=1, padx=10)

    def create_account(self):
        name = self.name_var.get()
        email = self.email_var.get()
        password = self.password_var.get()

        if self.controller.register_donor(name, email, password):
            # Clear fields and go back to login
            self.name_var.set("")
            self.email_var.set("")
            self.password_var.set("")
            self.controller.show_frame("LoginFrame")


class DashboardFrame(ttk.Frame):
    def __init__(self, parent, controller: AngelAndSparrowApp):
        super().__init__(parent)
        self.controller = controller

        # Header
        self.welcome_label = ttk.Label(self, text="Welcome!",
                                       font=("Arial", 16, "bold"))
        self.welcome_label.pack(pady=10)

        top_bar = ttk.Frame(self)
        top_bar.pack(fill="x", padx=10)

        self.volunteer_stats_label = ttk.Label(top_bar, text="")
        self.volunteer_stats_label.pack(side="left", padx=5)

        logout_btn = ttk.Button(top_bar, text="Log Out", command=self.logout)
        logout_btn.pack(side="right", padx=5)

        # Main content (left: donation form, right: history & volunteer)
        main_frame = ttk.Frame(self)
        main_frame.pack(fill="both", expand=True, padx=10, pady=10)

        # Donation form
        donation_frame = ttk.Labelframe(main_frame, text="Add Donation")
        donation_frame.pack(side="left", fill="y", padx=(0, 10))

        ttk.Label(donation_frame, text="Amount ($):").grid(row=0, column=0, sticky="e", padx=5, pady=5)
        ttk.Label(donation_frame, text="Category:").grid(row=1, column=0, sticky="e", padx=5, pady=5)
        ttk.Label(donation_frame, text="Note:").grid(row=2, column=0, sticky="ne", padx=5, pady=5)

        self.amount_var = tk.StringVar()
        self.category_var = tk.StringVar()
        self.note_text = tk.Text(donation_frame, width=30, height=5)

        amount_entry = ttk.Entry(donation_frame, textvariable=self.amount_var, width=20)
        amount_entry.grid(row=0, column=1, padx=5, pady=5, sticky="w")

        category_combo = ttk.Combobox(
            donation_frame, textvariable=self.category_var,
            values=["General", "Food", "Housing", "Education", "Other"],
            state="readonly", width=18
        )
        category_combo.grid(row=1, column=1, padx=5, pady=5, sticky="w")
        category_combo.current(0)

        self.note_text.grid(row=2, column=1, padx=5, pady=5, sticky="w")

        add_btn = ttk.Button(donation_frame, text="Save Donation",
                             command=self.save_donation)
        add_btn.grid(row=3, column=0, columnspan=2, pady=10)

        # Right side: donation history + volunteer section
        right_frame = ttk.Frame(main_frame)
        right_frame.pack(side="left", fill="both", expand=True)

        history_frame = ttk.Labelframe(right_frame, text="My Donation History")
        history_frame.pack(fill="both", expand=True, padx=(0, 5), pady=(0, 10))

        columns = ("date", "amount", "category", "note")
        self.history_tree = ttk.Treeview(
            history_frame, columns=columns, show="headings", height=10
        )
        self.history_tree.heading("date", text="Date")
        self.history_tree.heading("amount", text="Amount")
        self.history_tree.heading("category", text="Category")
        self.history_tree.heading("note", text="Note")
        self.history_tree.column("date", width=130)
        self.history_tree.column("amount", width=70, anchor="e")
        self.history_tree.column("category", width=80)
        self.history_tree.column("note", width=200)

        vsb = ttk.Scrollbar(history_frame, orient="vertical",
                            command=self.history_tree.yview)
        self.history_tree.configure(yscrollcommand=vsb.set)
        self.history_tree.pack(side="left", fill="both", expand=True)
        vsb.pack(side="right", fill="y")

        volunteer_frame = ttk.Labelframe(right_frame, text="Volunteer with Angel & Sparrow")
        volunteer_frame.pack(fill="x")

        self.volunteer_status_label = ttk.Label(volunteer_frame, text="")
        self.volunteer_status_label.pack(pady=5)

        volunteer_btn = ttk.Button(
            volunteer_frame, text="Sign Up to Volunteer",
            command=self.signup_volunteer
        )
        volunteer_btn.pack(pady=5)

    def refresh(self):
        # Update header text
        if self.controller.current_user:
            _, name, email = self.controller.current_user
            self.welcome_label.config(text=f"Welcome, {name} ({email})")

        # Update donation history
        for row in self.history_tree.get_children():
            self.history_tree.delete(row)

        for date, amount, category, note in self.controller.get_donation_history():
            self.history_tree.insert("", "end", values=(date, f"${amount:.2f}", category, note))

        # Update volunteer stats
        total, is_volunteer = self.controller.get_volunteer_stats()
        self.volunteer_stats_label.config(
            text=f"Total volunteers: {total}"
        )
        if is_volunteer:
            self.volunteer_status_label.config(
                text="You are already signed up as a volunteer. Thank you!"
            )
        else:
            self.volunteer_status_label.config(
                text="You are not signed up as a volunteer yet."
            )

    def save_donation(self):
        amount = self.amount_var.get()
        category = self.category_var.get()
        note = self.note_text.get("1.0", "end").strip()

        self.controller.add_donation(amount, category, note)
        # Refresh history after adding
        self.refresh()
        # Clear form
        self.amount_var.set("")
        self.note_text.delete("1.0", "end")

    def signup_volunteer(self):
        if self.controller.signup_volunteer():
            self.refresh()

    def logout(self):
        self.controller.current_user = None
        self.controller.show_frame("LoginFrame")


if __name__ == "__main__":
    app = AngelAndSparrowApp()
    app.mainloop()
